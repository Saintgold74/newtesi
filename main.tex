\documentclass[12pt,a4paper,oneside]{report}

\usepackage[utf8]{inputenc} % Codifica UTF-8
\usepackage[T1]{fontenc}

% ===== XELATEX: FONT ARIAL WINDOWS =====
\usepackage{fontspec}
\setmainfont{Arial}[
    BoldFont = {Arial Bold},
    ItalicFont = {Arial Italic},
    BoldItalicFont = {Arial Bold Italic}
]

% ===== LINGUA ITALIANA =====
\usepackage{polyglossia}
\setdefaultlanguage{italian}

% ===== MARGINI ESATTI COME DA REGOLAMENTO =====
\usepackage[
    top=3.5cm,
    bottom=3.5cm,
    left=4.5cm,
    right=3cm,
    headheight=15pt
]{geometry}

% ===== INTERLINEA 1.5 =====
\usepackage{setspace}
\onehalfspacing

% ===== RIENTRO PRIMA RIGA =====
\setlength{\parindent}{1.25cm}

% ===== BIBLATEX - CONFIGURAZIONE AVANZATA =====
\usepackage[
    backend=biber,              % Backend moderno
    style=authoryear,           % Note abbreviate (autore, anno)
    citestyle=authoryear-comp,  % Citazioni compatte
    bibstyle=authoryear,        % Bibliografia autore-anno
    sorting=nyt,                % Ordinamento nome-anno-titolo
    %refsection=chapter,         % Bibliografia per capitolo (disabilitato)
    maxbibnames=99,             % Mostra tutti gli autori
    giveninits=true,            % Usa iniziali per i nomi
    autolang=other,             % Gestione multilingua
    hyperref=true,              % Link cliccabili
    backref=false,              % No back-references
    url=true,                   % Mostra URL
    doi=true,                   % Mostra DOI
    isbn=false,                 % Non mostrare ISBN
    eprint=false,               % Non mostrare eprint
    autocite=footnote           % autocite genera note a piè pagina
]{biblatex}

% ===== FORMATTAZIONE BIBLIOGRAFIA SECONDO REGOLAMENTO =====

% Autori in MAIUSCOLETTO
\renewcommand{\mkbibnamefamily}[1]{\textsc{#1}}
\renewcommand{\mkbibnamegiven}[1]{#1}
\renewcommand{\mkbibnameprefix}[1]{#1}
\renewcommand{\mkbibnamesuffix}[1]{#1}

% Separatori e punteggiatura italiana
\renewcommand{\multinamedelim}{\addcomma\space}
\renewcommand{\finalnamedelim}{\addcomma\space}
\renewcommand{\labelnamepunct}{\addcomma\space}

% Formato titoli in corsivo per libri
\DeclareFieldFormat[book,thesis,report]{title}{\emph{#1}}
\DeclareFieldFormat[article]{title}{«#1»}

% Formato pagine
\DeclareFieldFormat{pages}{pp\adddot\space#1}
\DeclareFieldFormat{page}{p\adddot\space#1}

% Rimuovi "In:" prima del journal
\renewbibmacro{in:}{%
  \ifentrytype{article}{}{\printtext{\bibstring{in}\intitlepunct}}}

% Formato volume e numero per articoli
\DeclareFieldFormat[article]{volume}{\mkbibbold{#1}}
\DeclareFieldFormat[article]{number}{n\adddot\space#1}

% URL in font normale (non typewriter)
\DeclareFieldFormat{url}{\url{#1}}
\DeclareFieldFormat{doi}{DOI\addcolon\space\url{https://doi.org/#1}}

% ===== CONFIGURAZIONE NOTE A PIÈ PAGINA ABBREVIATE =====
% Le citazioni \autocite{} generano automaticamente note a piè di pagina
% con formato (Autore Anno) grazie al style authoryear con autocite=footnote

% DOPO: csquotes (NECESSARIO per BibLaTeX)
\usepackage{csquotes}  % ← IMPORTANTE!

% ===== CARICA FILE BIBLIOGRAFIA =====
%\usepackage[backend=biber,style=numeric]{biblatex}
% Opzione 1: File separati per capitolo
% \addbibresource{bibliografia/cap1_references.bib}
% \addbibresource{bibliografia/cap2_references.bib}
% \addbibresource{bibliografia/cap3_references.bib}
% \addbibresource{bibliografia/cap4_references.bib}
% \addbibresource{bibliografia/cap5_references.bib}

% Opzione 2: Un unico file (decommentare se preferito)
\addbibresource{bibliografia/newtesi_ref.bib}
%\addbibresource{bibliografia/biblio_pers.bib}

% ===== NOTE A PIÈ DI PAGINA =====
\usepackage[bottom,hang]{footmisc}
\usepackage{chngcntr}

% Reset numerazione note per ogni capitolo
\counterwithin{footnote}{chapter}

% Formattazione note secondo regolamento
\renewcommand{\footnotelayout}{%
    \setlength{\parindent}{0.6cm}%
    \fontsize{10}{12}\selectfont%
}

% Parentesi tonde per i numeri delle note
\renewcommand{\thefootnote}{(\arabic{footnote})}
\renewcommand{\footnoterule}{%
    \kern -3pt
    \hrule width \textwidth height 0.4pt
    \kern 2pt
}

% ===== COMANDI PER CITAZIONI =====
% Citazione normale nel testo: [1]
% \cite{chiave}

% Citazione in nota a piè pagina: (1)
% \footcite{chiave}

% Citazione con pagina specifica
% \cite[p.~45]{chiave}

% ===== PACCHETTI UTILI =====

\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{amsmath,amssymb,amsthm}
\usepackage{fancyhdr}
\usepackage{array}
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{pgfplots}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{enumitem}
\usepackage{listings}

\usepackage{xcolor} % Per i colori
\usepackage{standalone}
\usepackage[most]{tcolorbox} % Add this line to the preamble of your main.tex file
\usepackage{stackengine}
%\usepackage{csquotes} % Importante per BibLaTeX
\usepackage{biblatex}
\usepackage{tocloft} % Per personalizzare l'indice
% ===== CONFIGURAZIONE TITOLI CAPITOLI E SEZIONI =====
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{standalone}
\usepackage{algorithm}
\usepackage{algpseudocode}

\graphicspath{{figure/}}

\usepackage{tabularx}
\usepackage{colortbl}
\usepackage{booktabs}
\usepackage{xcolor}

% Definiamo i colori per le fasi
\definecolor{phase1}{HTML}{DAE8FC}
\definecolor{phase2}{HTML}{D5F5E3}
\definecolor{phase3}{HTML}{FCF3CF}
\definecolor{phase4}{HTML}{FADBD8}


\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=1.17}
\usetikzlibrary{shapes,arrows,positioning,calc,patterns,decorations.pathreplacing,shadows}
\usetikzlibrary{shapes.geometric,shapes.symbols,shapes.misc}
\usetikzlibrary{matrix,chains,scopes,fit,backgrounds}
\usetikzlibrary{arrows.meta, positioning, shapes, calc}

% Formato capitoli
\titleformat{\chapter}[display]
{\normalfont\fontsize{14}{16}\selectfont\bfseries}
{\MakeUppercase{\chaptertitlename}\ \thechapter}
{20pt}
{\fontsize{14}{16}\selectfont\bfseries\MakeUppercase}

% Formato sezioni (11pt, grassetto come da regolamento)
\titleformat{\section}
{\normalfont\fontsize{11}{13}\selectfont\bfseries}
{\thesection}
{1em}
{}

\titleformat{\subsection}
{\normalfont\fontsize{11}{13}\selectfont\bfseries}
{\thesubsection}
{1em}
{}

\titleformat{\subsubsection}
{\normalfont\fontsize{11}{13}\selectfont\bfseries}
{\thesubsubsection}
{1em}
{}

% Spaziatura titoli
\titlespacing*{\chapter}{0pt}{-20pt}{30pt}
\titlespacing*{\section}{0pt}{12pt}{6pt}
\titlespacing*{\subsection}{0pt}{12pt}{6pt}

% ===== NUMERAZIONE PAGINE =====
\pagestyle{fancy}
\fancyhf{}
\fancyfoot[C]{\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

\fancypagestyle{plain}{
    \fancyhf{}
    \fancyfoot[C]{\thepage}
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
}

% ===== CONFIGURAZIONE LISTINGS PER CODICE =====
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    commentstyle=\color{codegreen}\fontsize{10}{12}\selectfont,
    keywordstyle=\color{magenta}\fontsize{10}{12}\selectfont,
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple}\fontsize{10}{12}\selectfont,
    basicstyle=\ttfamily\fontsize{10}{12}\selectfont,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2
}
\lstset{style=mystyle}

\lstdefinelanguage{json}{%
  morekeywords={true, false, null},
  morestring=[b]",
  morecomment=[l]{//},
  morecomment=[s]{/*}{*/},
  sensitive=false,
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
  keywordstyle=\color{blue},
  stringstyle=\color{red},
  basicstyle=\ttfamily,
}

%Definizione ambiente per Innovation Box
\newtcolorbox{innovationbox}[1][]{
  colback=blue!5!white,
  colframe=blue!75!black,
  fonttitle=\bfseries,
  title={Innovation Box},
  #1
}




% ===== INDICE GENERALE - Formattazione =====
\usepackage{tocloft}
\renewcommand{\cftdot}{.}
\renewcommand{\cftchapleader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cftchapfont}{\normalfont}
\renewcommand{\cftchappagefont}{\normalfont}
\setlength{\cftchapnumwidth}{2em}

% ===== HYPERREF (sempre ultimo) =====
\usepackage[
    colorlinks=false,
    pdfborder={0 0 0},
    bookmarks=true,
    bookmarksopen=true,
    unicode=true
]{hyperref}




% ===== INIZIO DOCUMENTO =====
\begin{document}

% Frontespizio (senza numerazione)
\pagenumbering{gobble}
\input{capitoli/frontespizio}
\clearpage

% Prefazione (numerazione romana)
\pagenumbering{roman}
\input{capitoli/prefazione}
\clearpage

% Indice generale
\tableofcontents
\clearpage

% Indice delle figure
\listoffigures
\clearpage

% Indice delle tabelle
\listoftables
\clearpage

% Capitoli (numerazione araba)
\pagenumbering{arabic}
%%%%\include{capitoli/new1}
\include{capitoli/Cap1.tex}
\include{capitoli/Cap1rev.tex}
%%%%\include{capitoli/new2}
%%%%%\include{capitoli/Cap2.tex}
\include{capitoli/Cap2bis.tex}
\include{capitoli/Cap2bis-rev.tex}
%%%%\include{capitoli/new3}
\include{capitoli/Cap3.tex}
%%%%\include{capitoli/new4-2}
\include{capitoli/Cap4.tex}
%%%%\include{capitoli/new5}
%%%\include{capitoli/Cap5.tex}
\include{capitoli/Cap5bis.tex}
%\include{capitoli/new5-2}
%\include{capitoli/new_app}
%\include{capitoli/nuova_C}
\include{capitoli/appAbis}
%%%%\include{capitoli/new_appendix}

% Questa include TUTTE le fonti citate nell'intera tesi
\printbibliography[
    heading=bibintoc,
    title={Bibliografia Generale}
]

\end{document}